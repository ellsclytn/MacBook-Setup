---
- hosts: 127.0.0.1
  connection: local
  vars:
    laptop: "{{ lookup('env', 'LAPTOP') | bool }}"
    hass_api_token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32653438376566373531646539623364616636336565343262386465363265303135663639383831
          3637343930396565323430636266303963613533326633650a636637343335303765663966363739
          36343361666431613634306137626237306431306462396432616535363330363263373939316232
          3131323835326231610a343866666137336165643438613664656536326431616261666534356564
          62333237386139383939306364363962303637366364323431323036646339643262343934393738
          39303633303537666136616664646539343163626131333530356134326363373866353062396638
          33386666663835393834373562363838333933646437353635353839393430616433366634393961
          66343364623438636432613233396635616164626130613263346633663439313538346165613335
          35303839643964613234656434396330656362636331643133643935303735366334323433333432
          65616432643431633234643938373832353934643164306162656662323030646365626366666339
          63313136653865393735383030363836643832626234636531616466333539613966366139336535
          64316463396633363562366438643961636165373034356163636664613964336239653161663832
          36353362656435656462373464383563366334333337353435353061326436373139
  tasks:
    - name: /etc/X11/xorg.conf.d
      file:
        path: /etc/X11/xorg.conf.d
        owner: root
        group: root
        mode: '0755'
        state: directory
      become: true
    - name: Intel graphics configuration
      template:
        src: ./templates/10-intel.conf
        dest: /etc/X11/xorg.conf.d/10-intel.conf
        owner: root
        group: root
        mode: '0644'
      become: true
      when: laptop
    - name: Mouse/trackpad configuration
      template:
        src: ./templates/20-mouse.conf
        dest: /etc/X11/xorg.conf.d/20-mouse.conf
        owner: root
        group: root
        mode: '0644'
      become: true
    - name: Keyboard configuration
      template:
        src: ./templates/30-keyboard.conf
        dest: /etc/X11/xorg.conf.d/30-keyboard.conf
        owner: root
        group: root
        mode: '0644'
      become: true
    - name: /etc/systemd/system/getty@tty1.service.d
      file:
        path: /etc/systemd/system/getty@tty1.service.d
        owner: root
        group: root
        mode: '0755'
        state: directory
      become: true
    - name: Auto login configuration
      template:
        src: ./templates/systemd/system/getty@tty1.service.d/override.conf
        dest: /etc/systemd/system/getty@tty1.service.d/override.conf
        owner: root
        group: root
        mode: '0644'
      become: true
    - name: Monitor glow light application
      template:
        src: ./templates/bin/monitor-glow
        dest: /bin/monitor-glow
        owner: root
        group: root
        mode: '0605'
      become: true
      when: not laptop
    - name: Monitor glow light startup/shutdown service
      template:
        src: ./templates/systemd/system/monitor-glow.service
        dest: /etc/systemd/system/monitor-glow.service
        owner: root
        group: root
        mode: '0644'
      become: true
    - name: Reload systemd
      systemd:
        daemon_reload: true
      become: true
    - name: Enable and monitor glow
      systemd:
        state: started
        enabled: true
        name: monitor-glow
      become: true
    - name: Install Pacman packages
      pacman:
        name: "{{ lookup('file', '../setup/pacman').splitlines() }}"
        state: present
      become: true
    - name: Install laptop-specific Pacman packages
      pacman:
        name:
          - fprint
          - mesa
          - xf86-video-intel
        state: present
      when: laptop
    - name: Install desktop-specific Pacman packages
      pacman:
        name:
          - nvidia
          - nvidia-settings
          - picom
        state: present
      when: not laptop
      become: true
